function doPost(e) {
  try {
    const ss = SpreadsheetApp.openById("1RGRHiGyNzjv9kS7qJ5cYdm4EQOus9gBlkq-5GYW_Mn0");
    const sheet = ss.getSheetByName("Página1");  // Confirme o nome da aba
    const dados = JSON.parse(e.postData.contents);

    const nome = dados.nome;
    const cpf = dados.cpf;
    const tipo = dados.tipo;

    const dataAtual = new Date();
    const dataFormatada = Utilities.formatDate(dataAtual, "GMT-3", "dd/MM/yyyy");
    const horaFormatada = Utilities.formatDate(dataAtual, "GMT-3", "HH:mm:ss");

    const registros = sheet.getDataRange().getValues();

    let linhaEncontrada = -1;

    for (let i = 1; i < registros.length; i++) {
      const nomePlanilha = registros[i][0];
      const cpfPlanilha = registros[i][1];
      const dataPlanilha = registros[i][2];

      let dataPlanilhaFormatada = "";
      if (dataPlanilha instanceof Date) {
        dataPlanilhaFormatada = Utilities.formatDate(dataPlanilha, "GMT-3", "dd/MM/yyyy");
      } else if (typeof dataPlanilha === "string") {
        dataPlanilhaFormatada = dataPlanilha;
      }

      if (
        nomePlanilha === nome &&
        cpfPlanilha === cpf &&
        dataPlanilhaFormatada === dataFormatada
      ) {
        linhaEncontrada = i + 1;
        break;
      }
    }

    if (linhaEncontrada === -1) {
      sheet.appendRow([nome, cpf, dataAtual, "", "", "", ""]);
      linhaEncontrada = sheet.getLastRow();
    }

    let coluna = 0;
    switch (tipo) {
      case "Entrada":
        coluna = 4;
        break;
      case "Saída Almoço":
        coluna = 5;
        break;
      case "Volta Almoço":
        coluna = 6;
        break;
      case "Saída Final":
        coluna = 7;
        break;
    }

    if (coluna > 0) {
      sheet.getRange(linhaEncontrada, coluna).setValue(horaFormatada);
    }

    return ContentService.createTextOutput("OK");

  } catch (erro) {
    Logger.log("Erro: " + erro);
    return ContentService.createTextOutput("Erro");
  }
}
